name: EC2 Deploy

on:
  push:
    branches:
      - devops/a3
    tags:
      - deploy-dev
      - deploy-prod

  workflow_dispatch:
    inputs:
      stage:
        description: "Select stage to deploy"
        required: true
        default: dev
        type: choice
        options:
          - dev
          - prod

env:
  AWS_REGION: ap-south-1
  TF_WORKING_DIR: ./terraform

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Checkout Repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # Configure AWS Credentials
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        aws-output: json

    # Install Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    # Determine Stage - dev/prod defaults to dev
    - name: Determine Stage
      id: set_stage
      run: |
        if [[ "${GITHUB_REF}" == "refs/tags/deploy-dev" ]]; then
          echo "STAGE=dev" >> $GITHUB_ENV
        elif [[ "${GITHUB_REF}" == "refs/tags/deploy-prod" ]]; then
          echo "STAGE=prod" >> $GITHUB_ENV
        elif [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
          echo "STAGE=${{ github.event.inputs.stage }}" >> $GITHUB_ENV
        else
          echo "STAGE=dev" >> $GITHUB_ENV  # fallback
        fi

        echo "üõ†Ô∏è Deployment stage: $STAGE"

    # Terraform Init & Workspace
    - name: Terraform Init & Workspace
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        terraform init
        terraform workspace select ${STAGE} || terraform workspace new ${STAGE}

    # Terraform Apply
    - name: Terraform Apply
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        terraform apply -var-file="${STAGE}_config.tfvars" -auto-approve \
          -var "stage=${STAGE}"

    # Output and inject EC2 IPs & S3 Bucket name to Github Env
    - name: Get EC2s Public IPs & S3 Bucket Name
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "Injecting terraform outputs to github environment"
        INSTANCE_IP=$(terraform output -raw instance_public_ip)
        VERIFIER_IP=$(terraform output -raw verifier_instance_public_ip)
        S3_BUCKET=$(terraform output -raw s3_log_bucket)

        echo "INSTANCE_IP=$INSTANCE_IP" >> $GITHUB_ENV
        echo "VERIFIER_IP=$VERIFIER_IP" >> $GITHUB_ENV
        echo "S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV

        echo "üì¶ App IP (Shell): $INSTANCE_IP"
        echo "üîë Verifier IP (Shell): $VERIFIER_IP"
        echo "ü™£ S3 Bucket (Shell): $S3_BUCKET"

    # Wait for App Initialization
    - name: Wait for App Initialization
      run: |
        echo "‚è≥ Waiting 90 seconds for EC2 instances to initialize..."
        sleep 90

    # Validate App Health
    - name: Validate App Health
      run: |
        echo -e "\nüì¶ Full Response from App:\n"
        curl -s http://${{ env.INSTANCE_IP }}:80 || echo "‚ùå Failed to get response"
        echo -e "\n"
        echo "Checking app health at http://${{ env.INSTANCE_IP }}:80"
        for i in {1..10}; do
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://${{ env.INSTANCE_IP }}:80)
          if [[ "$STATUS" == "200" ]]; then
            echo "‚úÖ App is healthy (HTTP 200)"
            exit 0
          else
            echo "Attempt $i: got HTTP $STATUS"
            sleep 10
          fi
        done
        echo "‚ùå App failed health check"
        exit 1

    # Verify Logs in S3
    - name: Verify Logs in S3
      run: |
        echo "üì¶ Checking for logs in S3 bucket: $S3_BUCKET"
        aws s3 ls s3://$S3_BUCKET/${STAGE}/system/cloud-init.log || { echo "‚ùå system logs missing"; exit 1; }
        aws s3 ls s3://$S3_BUCKET/${STAGE}/app/my-app.log || { echo "‚ùå app logs missing"; exit 1; }
        echo "‚úÖ Logs found in S3 bucket"

    # Destroy (automatically always to avoid manual deletion)
    - name: Destroy infrastructure
      if: always()
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üóëÔ∏è Destroying infrastructure for stage: ${STAGE}"
        sleep 60
        terraform destroy -var-file="${STAGE}_config.tfvars" -auto-approve \
          -var "stage=${STAGE}"

    # Cleanup Terraform Workspace
    - name: Cleanup Terraform Workspace
      if: always()
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        terraform workspace select default
        terraform workspace delete ${STAGE}
