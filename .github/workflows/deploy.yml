name: Deploy to EC2

on:
  push:
    branches:
      - devops/a3
    tags:
      - 'deploy-*'    # Matches tags like deploy-dev, deploy-qa, deploy-prod
  workflow_dispatch:
    inputs:
      stage:
        description: 'Deployment stage (dev, qa, prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - prod

env:
  AWS_REGION: ap-south-1

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Determine Stage
      id: set_stage
      run: |
        STAGE_INPUT="${{ github.event.inputs.stage }}"
        STAGE=""

        if [[ "${GITHUB_REF}" == refs/tags/deploy-* ]]; then
          STAGE="${GITHUB_REF#refs/tags/deploy-}"
          echo "Tag trigger detected. Stage set to: $STAGE"
        elif [[ -n "$STAGE_INPUT" ]]; then
          STAGE="$STAGE_INPUT"
          echo "Manual trigger detected. Stage set to: $STAGE"
        else
          echo "Branch trigger detected (main). Defaulting stage to dev."
          STAGE="dev"
        fi

        # Validate stage
        if [[ "$STAGE" != "dev" && "$STAGE" != "qa" && "$STAGE" != "prod" ]]; then
          echo "Invalid stage: $STAGE. Must be dev, qa, or prod."
          exit 1
        fi

        echo "STAGE=$STAGE" >> $GITHUB_ENV

    # Checkout Code
    - name: Checkout repository
      uses: actions/checkout@v4

    # Configure AWS Credentials
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # Install Dependencies
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y unzip curl terraform

    # Setup SSH Private Key
    - name: Setup SSH Private Key
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ec2_key.pem
        chmod 400 ec2_key.pem

    # Make deploy.sh executable
    - name: Make deploy.sh executable
      run: chmod +x scripts/deploy.sh

    # Run deploy.sh with detected stage
    - name: Run deploy.sh
      run: |
        export PRIVATE_KEY_PATH="./ec2_key.pem"
        ./scripts/deploy.sh $STAGE
